// // 'use strict';

/**
 * Script to regenerate swagger from the Routes, etc.
 * @example
 * Shows how to how to customize the swagger after auto-generation
 * @see {@link https://dev.to/luizcalaca/autogenerated-documentation-api-with-openapi-and-swagger-for-nodejs-and-express-31g9 | tutorial }
 * @see {@link https://swagger-autogen.github.io/docs/openapi-3/ | swagger auto generator}
 * @module generator/swagger
 */

const fs = require('node:fs');
const path = require('path');
const Utility = require('./utility');
const swaggerAutogen = require('swagger-autogen')({ openapi: '3.0.0' });

module.exports = class OpenApi3Generation {
  /**
   * Generate Swagger in OpenAPI3 JSON
   * @param {string} outputFile - Path to the swagger.json
   * @param {array} urls - list to configure
   * @param {string} port - to use
   * @returns {string} openapi3filename
   */
  async generate(outputFile, urls, port) {
    if (!port || port <= 1) {
      return '';
    }

    if (Utility.isBlank(outputFile)) {
      outputFile = path.join(global.appRoot, 'swagger.json');
    }

    console.log(
      `Creating Swagger for Routers on Port: ${port} for ${urls.join('; ')}`
    );

    /**
     * Schemas: Person (Class), People (Array)
     */
    const comps = {
      components: {
        schemas: {
          Person: {
            $id: 'unique integer identity',
            $firstname: 'first name',
            $lastname: 'last name',
            cellphone: 'cell phone',
            company: 'company',
            email: 'email'
          },
          People: {
            type: 'array',
            items: {
              $ref: '#/components/schemas/Person'
            }
          }
        }
      }
    };

    /**
     * Add all routers here
     */
    const endpointsFiles = [
      './routers/personRouter.js',
      './routers/infoRouter.js'
    ];

    /**
     * Generate new swagger file then edit with Port, URL, etc.
     */
    await swaggerAutogen(outputFile, endpointsFiles, comps).then((data) => {
      const openapi3 = require(outputFile);
      const pkg = require(path.join(global.appRoot, 'package.json'));
      const version = pkg.version;

      console.log(`Updating ${outputFile} for version ${version}`);

      // Manual overrides
      openapi3.info.title = pkg.name;
      openapi3.info.description = pkg.description;
      openapi3.info.version = version;
      openapi3.info.contact = {};
      openapi3.info.contact.name = pkg.author;
      openapi3.info.contact.email = pkg.config.email;
      openapi3.info.contact.url = pkg.config.giturl;
      openapi3.info.license = {};
      openapi3.info.license.name = pkg.license;
      openapi3.info.license.url = pkg.config.licenseurl;

      let uct = 0;
      for (const url of urls) {
        if (url) {
          const fqdn = `${url}:${port}`;
          if (uct == 0) {
            openapi3.servers[0].url = fqdn;
          } else {
            openapi3.servers.push({ url: fqdn });
          }
        }
        uct = uct + 1;
      }

      // write updates
      const json = JSON.stringify(openapi3, null, 2);
      fs.writeFile(outputFile, json, (err) => {
        if (err) console.log(JSON.stringify(err));
      });
    });
    return outputFile;
  }
};
